<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRC Bangladesh - Regulatory Inspection Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* All existing CSS remains the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a3a8f 0%, #2a5bd7 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 140px);
        }

        .left-panel {
            flex: 3;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1;
            background-color: #fff;
            border-left: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.05);
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-bottom: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #2a5bd7;
        }

        .tab.active {
            color: #1a3a8f;
            border-bottom: 3px solid #1a3a8f;
            background-color: #f0f5ff;
        }

        .tab-content {
            display: none;
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            flex-grow: 1;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #2a5bd7;
        }

        .section h2 {
            color: #1a3a8f;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
        }

        .section h2 i {
            color: #2a5bd7;
        }

        .subsection {
            margin-bottom: 20px;
        }

        .subsection h3 {
            color: #444;
            margin-bottom: 12px;
            font-size: 17px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subsection h3 i {
            color: #2a5bd7;
            font-size: 15px;
        }

        /* NEW: Chart container styles */
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .chart-title {
            color: #1a3a8f;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .chart-item {
            flex: 1;
            min-width: 300px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Visualization grid */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .visualization-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .visualization-card h4 {
            color: #1a3a8f;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visualization-card .chart-wrapper {
            height: 250px;
        }

        /* Comparison visualizations */
        .comparison-visualization {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-chart {
            flex: 1;
            min-width: 300px;
        }

        /* Existing table styles remain */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        table th {
            background-color: #f0f5ff;
            color: #1a3a8f;
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }

        table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tr:hover {
            background-color: #f0f5ff;
        }

        .risk-high {
            color: #d32f2f;
            font-weight: 600;
            background-color: #ffebee;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .risk-moderate {
            color: #f57c00;
            font-weight: 600;
            background-color: #fff3e0;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .risk-low {
            color: #388e3c;
            font-weight: 600;
            background-color: #e8f5e9;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .file-list {
            list-style-type: none;
        }

        .file-item {
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #2a5bd7;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background-color: #f0f5ff;
            transform: translateX(5px);
        }

        .file-item.active {
            background-color: #e3eeff;
            border-left-color: #1a3a8f;
        }

        .file-name {
            font-weight: 600;
            color: #1a3a8f;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-type {
            font-size: 11px;
            color: #666;
            background-color: #eee;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 8px;
        }

        .file-year {
            font-size: 11px;
            color: #fff;
            background-color: #2a5bd7;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .pdf-viewer-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .pdf-viewer-container h3 {
            background-color: #f0f5ff;
            padding: 12px;
            margin: 0;
            color: #1a3a8f;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        #pdf-viewer {
            width: 100%;
            height: 450px;
            border: none;
        }

        .btn-export {
            background: linear-gradient(to right, #1a3a8f, #2a5bd7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(26, 58, 143, 0.3);
        }

        .compliance-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .compliant {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .partial {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .non-compliant {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .source-ref {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
        }

        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .tag-audit {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .tag-fs {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .tag-note {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .materiality-high {
            border-left: 4px solid #d32f2f;
        }

        .materiality-moderate {
            border-left: 4px solid #f57c00;
        }

        .year-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }

        .year-tab {
            padding: 8px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .year-tab:hover {
            color: #2a5bd7;
        }

        .year-tab.active {
            color: #1a3a8f;
            border-bottom: 3px solid #1a3a8f;
        }

        .year-content {
            display: none;
        }

        .year-content.active {
            display: block;
        }

        .comparison-table {
            display: flex;
            overflow-x: auto;
        }

        .comparison-col {
            min-width: 250px;
            margin-right: 20px;
        }

        .comparison-col h4 {
            background-color: #1a3a8f;
            color: white;
            padding: 10px;
            border-radius: 5px 5px 0 0;
            text-align: center;
            margin-bottom: 0;
        }

        .comparison-item {
            background-color: white;
            padding: 12px;
            border-bottom: 1px solid #eee;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .comparison-item:last-child {
            border-radius: 0 0 5px 5px;
            border-bottom: 1px solid #ddd;
        }

        .comparison-item .label {
            font-weight: 600;
            color: #555;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .comparison-item .value {
            font-size: 14px;
            color: #333;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #ddd;
            margin-top: 20px;
            background-color: #f9f9f9;
        }

        .key-findings {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .finding-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            border-top: 4px solid;
        }

        .finding-card.high {
            border-top-color: #d32f2f;
        }

        .finding-card.moderate {
            border-top-color: #f57c00;
        }

        .finding-card.low {
            border-top-color: #388e3c;
        }

        .finding-card h4 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .finding-card p {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .finding-card .action {
            font-size: 13px;
            color: #1a3a8f;
            font-weight: 600;
        }

        /* New styles for blank state */
        .blank-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .blank-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .blank-state h3 {
            color: #555;
            margin-bottom: 15px;
            font-size: 22px;
        }

        .blank-state p {
            max-width: 500px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .btn-load-company {
            background: linear-gradient(to right, #1a3a8f, #2a5bd7);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .btn-load-company:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(26, 58, 143, 0.3);
        }

        .company-selector {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f5ff;
            border-radius: 8px;
        }

        .company-selector h4 {
            color: #1a3a8f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .company-selector select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background-color: white;
            cursor: pointer;
        }

        .company-selector select:focus {
            outline: none;
            border-color: #2a5bd7;
            box-shadow: 0 0 0 2px rgba(42, 91, 215, 0.2);
        }

        /* New styles for data display */
        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        .data-table table {
            min-width: 800px;
        }

        .metric-value {
            font-weight: 600;
            color: #1a3a8f;
        }

        .metric-trend-up {
            color: #2e7d32;
        }

        .metric-trend-down {
            color: #d32f2f;
        }

        .metric-trend-stable {
            color: #f57c00;
        }

        .standard-compliance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .standard-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .standard-card.compliant {
            border-left-color: #2e7d32;
        }

        .standard-card.partial {
            border-left-color: #f57c00;
        }

        .standard-card.non-compliant {
            border-left-color: #d32f2f;
        }

        .standard-card h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .standard-card p {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .standard-card .status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .company-upload {
            margin-bottom: 25px;
        }

        .btn-upload {
            background: linear-gradient(to right, #1a3a8f, #2a5bd7);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            text-decoration: none;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(26, 58, 143, 0.3);
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }

            .right-panel {
                border-left: none;
                border-top: 1px solid #ddd;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .tab {
                white-space: nowrap;
            }

            .key-findings,
            .standard-compliance-grid,
            .visualization-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-row {
                flex-direction: column;
            }
            
            .comparison-visualization {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1><i class="fas fa-gavel"></i> Financial Reporting Council (FRC), Bangladesh</h1>
        <p id="header-subtitle">Regulatory Inspection Portal - Select a company to begin analysis</p>
    </div>

    <div class="tabs-container" style="position: sticky; top: 0; z-index: 100; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);">
        <div class="tabs">
            <div class="tab" onclick="switchTab(0)">
                <i class="fas fa-home"></i> Overview
            </div>
            <div class="tab" onclick="switchTab(1)">
                <i class="fas fa-search"></i> Audit Analysis
            </div>
            <div class="tab" onclick="switchTab(2)">
                <i class="fas fa-chart-line"></i> IFRS Compliance
            </div>
            <div class="tab active" onclick="switchTab(3)">
                <i class="fas fa-file-invoice-dollar"></i> Financial Analysis
            </div>
            <div class="tab" onclick="switchTab(4)">
                <i class="fas fa-exclamation-circle"></i> Risk Indicators
            </div>
            <div class="tab" onclick="switchTab(5)">
                <i class="fas fa-user-tie"></i> Governance
            </div>
            <div class="tab" onclick="switchTab(6)">
                <i class="fas fa-gavel"></i> Enforcement
            </div>
        </div>
    </div>

    <div class="container">
        <div class="left-panel">
            <!-- All Tab Contents - Initially empty -->
            <div class="tab-content active" id="tab-overview">
                <div class="blank-state" id="overview-blank">
                    <i class="fas fa-building"></i>
                    <h3>No Company Selected</h3>
                    <p>Select a company from the right panel to load its regulatory inspection data. The analysis includes financial statements, audit reports, IFRS compliance, and risk assessment for multiple years.</p>
                    <button class="btn-load-company" onclick="document.querySelector('.company-selector select').focus()">
                        <i class="fas fa-folder-open"></i> Select a Company
                    </button>
                </div>
                <!-- Overview content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-audit">
                <div class="blank-state" id="audit-blank">
                    <i class="fas fa-search"></i>
                    <h3>Audit Analysis</h3>
                    <p>Select a company to view detailed audit analysis including auditor opinions, emphasis of matter paragraphs, and scope limitations across multiple years.</p>
                </div>
                <!-- Audit content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-compliance">
                <div class="blank-state" id="compliance-blank">
                    <i class="fas fa-chart-line"></i>
                    <h3>IFRS Compliance</h3>
                    <p>Select a company to view IFRS/IAS compliance assessment with year-wise comparison and compliance trend analysis.</p>
                </div>
                <!-- Compliance content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-financial">
                <div class="blank-state" id="financial-blank">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <h3>Financial Analysis</h3>
                    <p>Select a company to view comprehensive financial statement analysis including profit & loss, balance sheet, cash flow, and key financial ratios.</p>
                </div>
                <!-- Financial content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-risk">
                <div class="blank-state" id="risk-blank">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Risk Indicators</h3>
                    <p>Select a company to view fraud and manipulation risk indicators with materiality assessment across multiple years.</p>
                </div>
                <!-- Risk content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-governance">
                <div class="blank-state" id="governance-blank">
                    <i class="fas fa-user-tie"></i>
                    <h3>Governance</h3>
                    <p>Select a company to view governance assessment including board effectiveness, audit quality, and internal control environment.</p>
                </div>
                <!-- Governance content will be loaded here dynamically -->
            </div>

            <div class="tab-content" id="tab-enforcement">
                <div class="blank-state" id="enforcement-blank">
                    <i class="fas fa-gavel"></i>
                    <h3>Enforcement</h3>
                    <p>Select a company to view regulatory findings, materiality assessment, and recommended enforcement actions.</p>
                </div>
                <!-- Enforcement content will be loaded here dynamically -->
            </div>
        </div>

        <!-- Right Panel - File Navigation & Company Selection -->
        <div class="right-panel">
            <h2 style="color: #1a3a8f; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-folder-open"></i> Company Selection
            </h2>

            <div class="company-selector">
                <h4><i class="fas fa-building"></i> Select Company</h4>
                <select id="companySelect" onchange="loadCompanyData()">
                    <option value="">-- Select a company --</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="company-upload">
                <a href="form.html" style="text-decoration: none;">
                    <button class="btn-upload">
                        <i class="fas fa-upload"></i> Upload Company Data
                    </button>
                </a>
            </div>

            <div id="fileNavigation" style="display: none;">
                <h3 style="color: #1a3a8f; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-pdf"></i> Processed Files
                </h3>

                <p style="margin-bottom: 20px; color: #666;">Select a file to view in the PDF viewer:</p>

                <div class="file-list" id="fileList">
                    <!-- Files will be loaded here -->
                </div>
            </div>
            
            <div class="pdf-viewer-container">
                <h3><i class="fas fa-eye"></i> Document Viewer</h3>
                <iframe id="pdf-viewer" src="https://mozilla.github.io/pdf.js/web/viewer.html?file="></iframe>
            </div>
            
            <div id="inspectorNotes"
                style="margin-top: 25px; padding: 15px; background-color: #f0f5ff; border-radius: 8px; display: none;">
                <h4 style="color: #1a3a8f; margin-bottom: 10px;"><i class="fas fa-lightbulb"></i> Inspector Notes</h4>
                <p id="notesContent" style="font-size: 14px; color: #555;"></p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>FRC Bangladesh - Regulatory Inspection Portal | Generated on <span id="current-date"></span></p>
        <p><i class="fas fa-info-circle"></i> Select a company from the dropdown to load its inspection data. All findings are linked to source documents for traceability.</p>
    </div>

    <script>
        // Global variable to store company data loaded from JSON
        let companyData = {};
        let currentCompany = null;
        let charts = {}; // Object to store chart instances

        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-GB', {
            day: 'numeric', month: 'long', year: 'numeric'
        });

        // Load JSON data on page load
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                // Load the JSON file
                const response = await fetch('companyData.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                companyData = await response.json();
                
                // Populate the company dropdown
                populateCompanyDropdown();
                
                // Initialize with blank state
                resetToBlankState();
                
                console.log('Company data loaded successfully:', Object.keys(companyData).length, 'companies');
            } catch (error) {
                console.error('Error loading company data:', error);
                alert('Failed to load company data. Please check if companyData.json exists and is accessible.');
            }
        });

        // Populate company dropdown from JSON data
        function populateCompanyDropdown() {
            const companySelect = document.getElementById('companySelect');
            
            // Clear existing options except the first one
            companySelect.innerHTML = '<option value="">-- Select a company --</option>';
            
            // Add options from the loaded JSON data
            Object.entries(companyData).forEach(([id, company]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = company.name;
                companySelect.appendChild(option);
            });
        }

        // Load company data when selected
        function loadCompanyData() {
            const select = document.getElementById('companySelect');
            const companyId = select.value;

            if (!companyId) {
                // Reset to blank state
                resetToBlankState();
                return;
            }

            currentCompany = companyData[companyId];

            if (!currentCompany) {
                alert("Company data not found!");
                return;
            }

            // Update header
            document.getElementById('header-subtitle').textContent = `Regulatory Inspection Portal - ${currentCompany.name}`;

            // Show file navigation
            document.getElementById('fileNavigation').style.display = 'block';
            document.getElementById('inspectorNotes').style.display = 'block';
            
            // Display inspector notes
            const notesContent = document.getElementById('notesContent');
            if (currentCompany.inspectorNotes) {
                notesContent.textContent = currentCompany.inspectorNotes;
            } else {
                notesContent.textContent = 'No inspector notes available.';
            }

            // Load PDF files
            loadPDFFiles();

            // Destroy existing charts before loading new ones
            destroyAllCharts();
            
            // Load all analysis data
            loadAllTabData();

            // Select first file if available
            if (currentCompany.pdfFiles && currentCompany.pdfFiles.length > 0) {
                selectFile(0);
            }
        }

        // Load PDF files into the file list
        function loadPDFFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            if (!currentCompany.pdfFiles || currentCompany.pdfFiles.length === 0) {
                fileList.innerHTML = '<p style="color: #666; font-style: italic;">No PDF files available for this company.</p>';
                return;
            }

            currentCompany.pdfFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item' + (index === 0 ? ' active' : '');
                fileItem.onclick = () => selectFile(index);

                fileItem.innerHTML = `
                    <div class="file-name"><i class="fas fa-file-pdf"></i> ${file.name || 'Unnamed File'}</div>
                    <div><span class="file-type">PDF</span> <span class="file-year">${file.year || 'N/A'}</span></div>
                    <div style="margin-top: 8px; font-size: 14px; color: #555;">${file.type || 'Unknown Type'}</div>
                `;

                fileList.appendChild(fileItem);
            });
        }

        // Select a file to view
        function selectFile(index) {
            // Update active file in list
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => item.classList.remove('active'));
            if (fileItems[index]) {
                fileItems[index].classList.add('active');
            }

            // Update PDF viewer if it exists
            const pdfViewer = document.getElementById('pdf-viewer');
            if (pdfViewer && currentCompany.pdfFiles && currentCompany.pdfFiles[index]) {
                const file = currentCompany.pdfFiles[index];
                // Use a placeholder if no URL is provided
                const fileUrl = file.url || `placeholder_${file.name || 'document'}.pdf`;
                pdfViewer.src = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(fileUrl)}`;
            }
        }

        // Destroy all existing charts
        function destroyAllCharts() {
            Object.keys(charts).forEach(chartId => {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                }
            });
            charts = {};
        }

        // Load all tab data
        function loadAllTabData() {
            // Hide blank states
            document.querySelectorAll('.blank-state').forEach(state => {
                state.style.display = 'none';
            });

            // Clear any previously loaded content
            document.querySelectorAll('.section').forEach(section => {
                section.remove();
            });

            // Check if company has the required data structure
            if (!currentCompany) {
                console.warn('No company data available');
                return;
            }

            // Load data for each tab
            loadOverviewData();
            loadAuditAnalysisData();
            loadComplianceData();
            loadFinancialAnalysisData();
            loadRiskIndicatorsData();
            loadGovernanceData();
            loadEnforcementData();
        }

        // Load overview data with visualizations
        function loadOverviewData() {
            const overviewTab = document.getElementById('tab-overview');
            
            if (!currentCompany.overview) {
                overviewTab.innerHTML += '<div class="section"><h2><i class="fas fa-exclamation-triangle"></i> No Overview Data</h2><p>This company does not have overview data available.</p></div>';
                return;
            }

            let overviewContent = `
                <div class="section">
                    <h2><i class="fas fa-info-circle"></i> Inspection Overview</h2>
                    <p>${currentCompany.overview.description || 'No description available.'}</p>
                    
                    ${currentCompany.overview.keyFindings && currentCompany.overview.keyFindings.length > 0 ? `
                    <div class="subsection">
                        <h3><i class="fas fa-exclamation-triangle"></i> Key Findings</h3>
                        <div class="key-findings">
                            ${currentCompany.overview.keyFindings.map(finding => `
                                <div class="finding-card ${finding.severity || 'moderate'}">
                                    <h4><i class="fas fa-exclamation-triangle"></i> ${finding.title || 'Untitled Finding'}</h4>
                                    <p>${finding.description || 'No description'}</p>
                                    <div class="action">${finding.action || 'Action required'}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Add year-wise data if available
            if (currentCompany.overview.yearData && currentCompany.years && currentCompany.years.length > 0) {
                overviewContent += `
                    <div class="section">
                        <h2><i class="fas fa-calendar-alt"></i> Year-Wise Summary</h2>
                        
                        <div class="year-tabs">
                            ${currentCompany.years.map((year, index) => `
                                <div class="year-tab ${index === 0 ? 'active' : ''}" onclick="switchYear('overview', ${index})">${year}</div>
                            `).join('')}
                            <div class="year-tab" onclick="switchYear('overview', ${currentCompany.years.length})">Comparison</div>
                        </div>
                        
                        ${currentCompany.years.map((year, index) => {
                            const yearData = currentCompany.overview.yearData[year];
                            if (!yearData) return '';
                            
                            return `
                                <div class="year-content ${index === 0 ? 'active' : ''}" id="overview-year-${year}">
                                    <div class="comparison-table">
                                        <div class="comparison-col">
                                            <h4>Audit Report</h4>
                                            <div class="comparison-item">
                                                <div class="label">Opinion Type</div>
                                                <div class="value">${yearData.auditOpinion || 'Not available'}</div>
                                            </div>
                                            <div class="comparison-item">
                                                <div class="label">Revenue</div>
                                                <div class="value">${yearData.revenue || 'Not available'}</div>
                                            </div>
                                            <div class="comparison-item">
                                                <div class="label">Net Profit/(Loss)</div>
                                                <div class="value">${yearData.netProfit || yearData.netLoss || 'Not available'}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="comparison-col">
                                            <h4>Financial Position</h4>
                                            <div class="comparison-item">
                                                <div class="label">Total Liabilities</div>
                                                <div class="value">${yearData.totalLiabilities || 'Not available'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        <div class="year-content" id="overview-year-comparison">
                            <div class="subsection">
                                <h3><i class="fas fa-chart-bar"></i> Year Trend Analysis</h3>
                                ${currentCompany.financialAnalysis && currentCompany.financialAnalysis.ratios ? `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Current Ratio</td>
                                            ${currentCompany.years.map(year => `<td>${currentCompany.financialAnalysis.ratios[year]?.currentRatio || 'N/A'}</td>`).join('')}
                                            <td><i class="fas fa-${getTrendIcon('currentRatio')}" style="color:${getTrendColor('currentRatio')}"></i></td>
                                        </tr>
                                        <tr>
                                            <td>Debt to Equity Ratio</td>
                                            ${currentCompany.years.map(year => `<td>${currentCompany.financialAnalysis.ratios[year]?.debtToEquity || 'N/A'}</td>`).join('')}
                                            <td><i class="fas fa-${getTrendIcon('debtToEquity')}" style="color:${getTrendColor('debtToEquity')}"></i></td>
                                        </tr>
                                    </tbody>
                                </table>
                                ` : '<p>No trend data available.</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            overviewTab.insertAdjacentHTML('beforeend', overviewContent);
            
            // Add visualization section for overview
            if (currentCompany.financialAnalysis && currentCompany.years && currentCompany.years.length > 0) {
                addOverviewVisualizations();
            }
        }

        // Add overview visualizations
        function addOverviewVisualizations() {
            const overviewTab = document.getElementById('tab-overview');
            
            // Create visualization section
            const vizSection = document.createElement('div');
            vizSection.className = 'section';
            vizSection.innerHTML = `
                <h2><i class="fas fa-chart-pie"></i> Data Visualizations</h2>
                <div class="subsection">
                    <h3><i class="fas fa-chart-bar"></i> Performance Overview</h3>
                    
                    <div class="visualization-grid">
                        <!-- Revenue & Profit Trend Chart -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-line"></i> Revenue & Profit Trend</h4>
                            <div class="chart-wrapper">
                                <canvas id="revenueProfitChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Financial Ratios Chart -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-bar"></i> Key Financial Ratios</h4>
                            <div class="chart-wrapper">
                                <canvas id="financialRatiosChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Risk Distribution Chart -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-pie"></i> Risk Level Distribution</h4>
                            <div class="chart-wrapper">
                                <canvas id="riskDistributionChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Compliance Status Chart -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-pie"></i> Compliance Status</h4>
                            <div class="chart-wrapper">
                                <canvas id="complianceStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            overviewTab.appendChild(vizSection);
            
            // Now create the charts
            createOverviewCharts();
        }

        // Create overview charts
        function createOverviewCharts() {
            // 1. Revenue & Profit Trend Chart
            const years = currentCompany.years;
            const revenueData = years.map(year => {
                const value = currentCompany.financialAnalysis?.profitLoss?.[year]?.revenue;
                return value ? parseFloat(value.replace(/[^0-9.-]+/g, '')) : 0;
            });
            
            const profitData = years.map(year => {
                const value = currentCompany.financialAnalysis?.profitLoss?.[year]?.netProfit;
                if (!value) return 0;
                const num = parseFloat(value.replace(/[(),]/g, ''));
                return value.startsWith('(') ? -num : num;
            });
            
            createLineChart('revenueProfitChart', {
                labels: years,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#1a3a8f',
                        backgroundColor: 'rgba(26, 58, 143, 0.1)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'Net Profit/(Loss)',
                        data: profitData,
                        borderColor: profitData[profitData.length-1] >= 0 ? '#388e3c' : '#d32f2f',
                        backgroundColor: profitData[profitData.length-1] >= 0 ? 'rgba(56, 142, 60, 0.1)' : 'rgba(211, 47, 47, 0.1)',
                        tension: 0.1,
                        fill: true
                    }
                ]
            });
            
            // 2. Financial Ratios Chart
            const ratioNames = ['Current Ratio', 'Debt to Equity', 'Return on Assets', 'Gross Margin'];
            const ratioData = ratioNames.map(ratioName => {
                const key = ratioName.toLowerCase().replace(/ /g, '');
                const lastYear = years[years.length - 1];
                const value = currentCompany.financialAnalysis?.ratios?.[lastYear]?.[key];
                return value ? parseFloat(value) : 0;
            });
            
            createBarChart('financialRatiosChart', {
                labels: ratioNames,
                datasets: [{
                    label: `Latest Values (${years[years.length - 1]})`,
                    data: ratioData,
                    backgroundColor: ratioData.map(value => {
                        if (ratioNames[0].includes('Current') && value < 1) return '#d32f2f';
                        if (ratioNames[1].includes('Debt') && value > 1) return '#d32f2f';
                        if (ratioNames[2].includes('Return') && value < 0) return '#d32f2f';
                        if (ratioNames[3].includes('Margin') && value < 10) return '#d32f2f';
                        return '#2a5bd7';
                    }),
                    borderColor: '#1a3a8f',
                    borderWidth: 1
                }]
            });
            
            // 3. Risk Distribution Chart
            if (currentCompany.riskIndicators?.aggregateRisks) {
                const riskLevels = ['High', 'Moderate', 'Low'];
                const riskCounts = riskLevels.map(level => {
                    return currentCompany.riskIndicators.aggregateRisks.filter(
                        risk => risk.aggregate?.toLowerCase() === level.toLowerCase()
                    ).length;
                });
                
                createPieChart('riskDistributionChart', {
                    labels: riskLevels,
                    datasets: [{
                        data: riskCounts,
                        backgroundColor: ['#d32f2f', '#f57c00', '#388e3c'],
                        borderColor: ['#b71c1c', '#e65100', '#2e7d32'],
                        borderWidth: 1
                    }]
                });
            }
            
            // 4. Compliance Status Chart
            if (currentCompany.ifrsCompliance?.standards) {
                const complianceStatus = {
                    compliant: 0,
                    partial: 0,
                    'non-compliant': 0
                };
                
                Object.values(currentCompany.ifrsCompliance.standards).forEach(standard => {
                    const lastYear = years[years.length - 1];
                    const status = standard[lastYear];
                    if (status && complianceStatus.hasOwnProperty(status)) {
                        complianceStatus[status]++;
                    }
                });
                
                createDoughnutChart('complianceStatusChart', {
                    labels: ['Compliant', 'Partial', 'Non-compliant'],
                    datasets: [{
                        data: [complianceStatus.compliant, complianceStatus.partial, complianceStatus['non-compliant']],
                        backgroundColor: ['#2e7d32', '#f57c00', '#d32f2f'],
                        borderColor: ['#1b5e20', '#e65100', '#b71c1c'],
                        borderWidth: 1
                    }]
                });
            }
        }

        // Load financial analysis data with visualizations
        function loadFinancialAnalysisData() {
            const financialTab = document.getElementById('tab-financial');
            
            // Clear any existing content first
            financialTab.querySelectorAll('.section').forEach(section => section.remove());
            
            if (!currentCompany.financialAnalysis) {
                financialTab.innerHTML += '<div class="section"><h2><i class="fas fa-exclamation-triangle"></i> No Financial Analysis Data</h2><p>This company does not have financial analysis data available.</p></div>';
                return;
            }

            let financialContent = `
                <div class="section">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Financial Analysis</h2>
                    
                    <div class="year-tabs">
                        <div class="year-tab active" onclick="switchYear('financial', 0)">Profit & Loss</div>
                        <div class="year-tab" onclick="switchYear('financial', 1)">Balance Sheet</div>
                        <div class="year-tab" onclick="switchYear('financial', 2)">Cash Flow</div>
                        <div class="year-tab" onclick="switchYear('financial', 3)">Ratios</div>
                        <div class="year-tab" onclick="switchYear('financial', 4)">Accrual Analysis</div>
                        <div class="year-tab" onclick="switchYear('financial', 5)">Visualizations</div>
                    </div>
                    
                    <!-- Profit & Loss -->
                    <div class="year-content active" id="financial-pl">
                        <div class="subsection">
                            <h3><i class="fas fa-chart-line"></i> Profit & Loss Statement</h3>
                            ${currentCompany.financialAnalysis.profitLoss ? `
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Particulars</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Revenue -->
                                        <tr>
                                            <td><strong>Revenue</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.profitLoss[year]?.revenue || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('revenue', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Direct Expenses -->
                                        <tr>
                                            <td>Direct Expenses</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.directExpenses) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('directExpenses', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Gross Profit -->
                                        <tr style="border-bottom: 2px solid #ddd;">
                                            <td><strong>Gross Profit/(Loss)</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.profitLoss[year]?.grossProfit || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.grossProfit) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('grossProfit', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Administrative Expenses -->
                                        <tr>
                                            <td>Administrative Expenses</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.adminExpenses) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('adminExpenses', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Operating Income -->
                                        <tr>
                                            <td>Operating Income</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.profitLoss[year]?.operatingIncome || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.operatingIncome) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('operatingIncome', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Non-Operating Income -->
                                        <tr>
                                            <td>Non-Operating Income</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.profitLoss[year]?.nonOperatingIncome || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('nonOperatingIncome', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Financial Expenses -->
                                        <tr>
                                            <td>Financial Expenses</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.financialExpenses) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('financialExpenses', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Profit Before Tax -->
                                        <tr style="border-bottom: 2px solid #ddd;">
                                            <td><strong>Profit/(Loss) Before Tax</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.profitLoss[year]?.profitBeforeTax || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss[year]?.profitBeforeTax) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('profitBeforeTax', 'profitLoss')}</td>
                                        </tr>
                                        
                                        <!-- Net Profit/(Loss) -->
                                        <tr style="background-color: #f0f5ff;">
                                            <td><strong>NET PROFIT/(LOSS)</strong></td>
                                            ${currentCompany.years.map(year => {
                                                const netProfit = currentCompany.financialAnalysis.profitLoss[year]?.netProfit;
                                                const isNegative = netProfit && (netProfit.startsWith('(') || parseFloat(netProfit.replace(/[(),]/g, '')) < 0);
                                                return `<td class="metric-value ${isNegative ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(netProfit) || 'N/A'}</td>`;
                                            }).join('')}
                                            <td>${getFinancialTrendIcon('netProfit', 'profitLoss')}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            ` : '<p>No profit and loss data available.</p>'}
                        </div>
                    </div>
                    
                    <!-- Balance Sheet -->
                    <div class="year-content" id="financial-bs">
                        <div class="subsection">
                            <h3><i class="fas fa-balance-scale"></i> Balance Sheet</h3>
                            ${currentCompany.financialAnalysis.balanceSheet ? `
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Particulars</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Growth</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- ASSETS -->
                                        <tr>
                                            <td colspan="${currentCompany.years.length + 2}" style="background-color: #1a3a8f; color: white; font-weight: bold; text-align: center;">ASSETS</td>
                                        </tr>
                                        
                                        <!-- Property, Plant & Equipment -->
                                        <tr>
                                            <td>Property, Plant & Equipment</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.ppe || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('ppe', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Investments -->
                                        <tr>
                                            <td>Investments</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.investments || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('investments', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Inventory -->
                                        <tr>
                                            <td>Inventory</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.inventory || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('inventory', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Total Assets -->
                                        <tr style="border-bottom: 2px solid #ddd;">
                                            <td><strong>TOTAL ASSETS</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.totalAssets || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('totalAssets', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- EQUITY & LIABILITIES -->
                                        <tr>
                                            <td colspan="${currentCompany.years.length + 2}" style="background-color: #1a3a8f; color: white; font-weight: bold; text-align: center;">EQUITY & LIABILITIES</td>
                                        </tr>
                                        
                                        <!-- Share Capital -->
                                        <tr>
                                            <td>Share Capital</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.shareCapital || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('shareCapital', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Retained Earnings -->
                                        <tr>
                                            <td>Retained Earnings</td>
                                            ${currentCompany.years.map(year => {
                                                const retainedEarnings = currentCompany.financialAnalysis.balanceSheet[year]?.retainedEarnings;
                                                const isNegative = retainedEarnings && (retainedEarnings.startsWith('(') || parseFloat(retainedEarnings.replace(/[(),]/g, '')) < 0);
                                                return `<td class="metric-value ${isNegative ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(retainedEarnings) || 'N/A'}</td>`;
                                            }).join('')}
                                            <td>${getFinancialTrendIcon('retainedEarnings', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Long Term Loans -->
                                        <tr>
                                            <td>Long Term Loans</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.longTermLoans || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('longTermLoans', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Short Term Loans -->
                                        <tr>
                                            <td>Short Term Loans</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.shortTermLoans || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('shortTermLoans', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Total Liabilities -->
                                        <tr style="background-color: #f0f5ff;">
                                            <td><strong>TOTAL LIABILITIES</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.balanceSheet[year]?.totalLiabilities || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('totalLiabilities', 'balanceSheet')}</td>
                                        </tr>
                                        
                                        <!-- Financial Position Analysis -->
                                        <tr style="border-top: 2px solid #ddd;">
                                            <td colspan="${currentCompany.years.length + 2}" style="background-color: #f9f9f9; padding: 10px;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <div>
                                                        <strong>Debt to Equity Ratio:</strong><br>
                                                        ${currentCompany.years.map(year => `${year}: ${currentCompany.financialAnalysis.ratios?.[year]?.debtToEquity || 'N/A'}`).join(' | ')}
                                                    </div>
                                                    <div>
                                                        <strong>Current Ratio:</strong><br>
                                                        ${currentCompany.years.map(year => `${year}: ${currentCompany.financialAnalysis.ratios?.[year]?.currentRatio || 'N/A'}`).join(' | ')}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            ` : '<p>No balance sheet data available.</p>'}
                        </div>
                    </div>
                    
                    <!-- Cash Flow -->
                    <div class="year-content" id="financial-cf">
                        <div class="subsection">
                            <h3><i class="fas fa-money-bill-wave"></i> Cash Flow Statement</h3>
                            ${currentCompany.financialAnalysis.cashFlow ? `
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Particulars</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Operating Activities -->
                                        <tr>
                                            <td><strong>Cash Flow from Operating Activities</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.operating || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow[year]?.operating) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('operating', 'cashFlow')}</td>
                                        </tr>
                                        
                                        <!-- Investing Activities -->
                                        <tr>
                                            <td>Cash Flow from Investing Activities</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.investing || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow[year]?.investing) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('investing', 'cashFlow')}</td>
                                        </tr>
                                        
                                        <!-- Financing Activities -->
                                        <tr>
                                            <td>Cash Flow from Financing Activities</td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.financing || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow[year]?.financing) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('financing', 'cashFlow')}</td>
                                        </tr>
                                        
                                        <!-- Net Change in Cash -->
                                        <tr style="border-bottom: 2px solid #ddd;">
                                            <td><strong>Net Increase/(Decrease) in Cash</strong></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value ${parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.netChange || 0) < 0 ? 'metric-trend-down' : 'metric-trend-up'}">${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow[year]?.netChange) || 'N/A'}</td>`).join('')}
                                            <td>${getFinancialTrendIcon('netChange', 'cashFlow')}</td>
                                        </tr>
                                        
                                        <!-- Cash Flow Analysis -->
                                        <tr>
                                            <td colspan="${currentCompany.years.length + 2}" style="background-color: #f9f9f9; padding: 10px;">
                                                <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                                                    <div style="margin-bottom: 10px;">
                                                        <strong>Cash Flow Patterns:</strong><br>
                                                        ${analyzeCashFlowPatterns()}
                                                    </div>
                                                    <div style="margin-bottom: 10px;">
                                                        <strong>Cash Flow to Income Ratio:</strong><br>
                                                        ${currentCompany.years.map(year => `${year}: ${currentCompany.financialAnalysis.ratios?.[year]?.cashFlowToIncome || 'N/A'}`).join(' | ')}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            ` : '<p>No cash flow data available.</p>'}
                        </div>
                    </div>
                    
                    <!-- Ratios -->
                    <div class="year-content" id="financial-ratios">
                        <div class="subsection">
                            <h3><i class="fas fa-calculator"></i> Financial Ratios</h3>
                            ${currentCompany.financialAnalysis.ratios ? `
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Ratio</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Assessment</th>
                                            <th>Industry Benchmark</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Current Ratio -->
                                        <tr>
                                            <td><strong>Current Ratio</strong><br><span style="font-size: 12px; color: #666;">(Current Assets / Current Liabilities)</span></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.ratios[year]?.currentRatio || 'N/A'}</td>`).join('')}
                                            <td>${getRatioAssessment('currentRatio')}</td>
                                            <td> 1.5</td>
                                        </tr>
                                        
                                        <!-- Debt to Equity Ratio -->
                                        <tr>
                                            <td><strong>Debt to Equity Ratio</strong><br><span style="font-size: 12px; color: #666;">(Total Debt / Shareholders' Equity)</span></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.ratios[year]?.debtToEquity || 'N/A'}</td>`).join('')}
                                            <td>${getRatioAssessment('debtToEquity')}</td>
                                            <td> 0.7</td>
                                        </tr>
                                        
                                        <!-- Return on Assets -->
                                        <tr>
                                            <td><strong>Return on Assets (ROA)</strong><br><span style="font-size: 12px; color: #666;">(Net Income / Total Assets)</span></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.ratios[year]?.returnOnAssets || 'N/A'}</td>`).join('')}
                                            <td>${getRatioAssessment('returnOnAssets')}</td>
                                            <td> 5%</td>
                                        </tr>
                                        
                                        <!-- Gross Margin -->
                                        <tr>
                                            <td><strong>Gross Margin</strong><br><span style="font-size: 12px; color: #666;">(Gross Profit / Revenue)</span></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.ratios[year]?.grossMargin || 'N/A'}</td>`).join('')}
                                            <td>${getRatioAssessment('grossMargin')}</td>
                                            <td> 30%</td>
                                        </tr>
                                        
                                        <!-- Cash Flow to Income -->
                                        <tr>
                                            <td><strong>Cash Flow to Income</strong><br><span style="font-size: 12px; color: #666;">(Operating Cash Flow / Net Income)</span></td>
                                            ${currentCompany.years.map(year => `<td class="metric-value">${currentCompany.financialAnalysis.ratios[year]?.cashFlowToIncome || 'N/A'}</td>`).join('')}
                                            <td>${getRatioAssessment('cashFlowToIncome')}</td>
                                            <td> 1.0</td>
                                        </tr>
                                        
                                        <!-- Additional Ratios (if available) -->
                                        ${currentCompany.financialAnalysis.ratios[currentCompany.years[0]] ? 
                                            Object.keys(currentCompany.financialAnalysis.ratios[currentCompany.years[0]])
                                                .filter(ratio => !['currentRatio', 'debtToEquity', 'returnOnAssets', 'grossMargin', 'cashFlowToIncome'].includes(ratio))
                                                .map(ratio => `
                                                    <tr>
                                                        <td><strong>${formatRatioName(ratio)}</strong></td>
                                                        ${currentCompany.years.map(year => `<td>${currentCompany.financialAnalysis.ratios[year]?.[ratio] || 'N/A'}</td>`).join('')}
                                                        <td>${getRatioAssessment(ratio)}</td>
                                                        <td>-</td>
                                                    </tr>
                                                `).join('')
                                            : ''
                                        }
                                        
                                        <!-- Ratio Summary -->
                                        <tr style="background-color: #f0f5ff;">
                                            <td colspan="${currentCompany.years.length + 3}" style="padding: 15px;">
                                                <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                                                    <div style="margin-bottom: 10px;">
                                                        <strong>Overall Financial Health:</strong> ${getOverallFinancialHealth()}
                                                    </div>
                                                    <div style="margin-bottom: 10px;">
                                                        <strong>Risk Level:</strong> ${getOverallRiskLevel()}
                                                    </div>
                                                    <div style="margin-bottom: 10px;">
                                                        <strong>Trend:</strong> ${getRatioTrendAnalysis()}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            ` : '<p>No financial ratios data available.</p>'}
                        </div>
                    </div>
                    
                    <!-- Accrual Analysis -->
                    <div class="year-content" id="financial-accrual">
                        <div class="subsection">
                            <h3><i class="fas fa-chart-area"></i> Financial Statement Analysis</h3>
                            
                            <div class="key-findings">
                                <!-- Profitability Analysis -->
                                <div class="finding-card ${getProfitabilityRiskLevel()}">
                                    <h4><i class="fas fa-chart-line"></i> Profitability Analysis</h4>
                                    <p><strong>Trend:</strong> ${analyzeProfitabilityTrend()}</p>
                                    <p><strong>Key Metrics:</strong> 
                                        ${currentCompany.years.map(year => `
                                            ${year}: Gross Margin ${currentCompany.financialAnalysis.ratios?.[year]?.grossMargin || 'N/A'}, 
                                            ROA ${currentCompany.financialAnalysis.ratios?.[year]?.returnOnAssets || 'N/A'}
                                        `).join('<br>')}
                                    </p>
                                    <div class="action">${getProfitabilityRecommendation()}</div>
                                </div>
                                
                                <!-- Liquidity Analysis -->
                                <div class="finding-card ${getLiquidityRiskLevel()}">
                                    <h4><i class="fas fa-tint"></i> Liquidity Analysis</h4>
                                    <p><strong>Current Ratio Trend:</strong> ${analyzeLiquidityTrend()}</p>
                                    <p><strong>Cash Position:</strong> 
                                        ${currentCompany.years.map(year => `
                                            ${year}: Net Cash Flow ${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow?.[year]?.netChange) || 'N/A'}
                                        `).join('<br>')}
                                    </p>
                                    <div class="action">${getLiquidityRecommendation()}</div>
                                </div>
                                
                                <!-- Solvency Analysis -->
                                <div class="finding-card ${getSolvencyRiskLevel()}">
                                    <h4><i class="fas fa-balance-scale"></i> Solvency Analysis</h4>
                                    <p><strong>Debt Position:</strong> ${analyzeDebtTrend()}</p>
                                    <p><strong>Leverage:</strong> 
                                        ${currentCompany.years.map(year => `
                                            ${year}: Debt to Equity ${currentCompany.financialAnalysis.ratios?.[year]?.debtToEquity || 'N/A'}
                                        `).join('<br>')}
                                    </p>
                                    <div class="action">${getSolvencyRecommendation()}</div>
                                </div>
                                
                                <!-- Cash Flow Analysis -->
                                <div class="finding-card ${getCashFlowRiskLevel()}">
                                    <h4><i class="fas fa-money-bill-wave"></i> Cash Flow Analysis</h4>
                                    <p><strong>Operating Cash Flow:</strong> ${analyzeOperatingCashFlow()}</p>
                                    <p><strong>Pattern:</strong> ${analyzeCashFlowPatterns()}</p>
                                    <div class="action">${getCashFlowRecommendation()}</div>
                                </div>
                            </div>
                            
                            <!-- Comparative Analysis Table -->
                            <div class="subsection" style="margin-top: 20px;">
                                <h3><i class="fas fa-chart-bar"></i> Year-over-Year Growth Analysis</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                            <th>Growth Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Revenue Growth</td>
                                            ${currentCompany.years.map(year => `<td>${currentCompany.financialAnalysis.profitLoss?.[year]?.revenue || 'N/A'}</td>`).join('')}
                                            <td>${calculateGrowthRate('revenue', 'profitLoss')}</td>
                                        </tr>
                                        <tr>
                                            <td>Net Profit Growth</td>
                                            ${currentCompany.years.map(year => `<td>${formatNegativeNumber(currentCompany.financialAnalysis.profitLoss?.[year]?.netProfit) || 'N/A'}</td>`).join('')}
                                            <td>${calculateGrowthRate('netProfit', 'profitLoss')}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Assets Growth</td>
                                            ${currentCompany.years.map(year => `<td>${currentCompany.financialAnalysis.balanceSheet?.[year]?.totalAssets || 'N/A'}</td>`).join('')}
                                            <td>${calculateGrowthRate('totalAssets', 'balanceSheet')}</td>
                                        </tr>
                                        <tr>
                                            <td>Operating Cash Flow Growth</td>
                                            ${currentCompany.years.map(year => `<td>${formatNegativeNumber(currentCompany.financialAnalysis.cashFlow?.[year]?.operating) || 'N/A'}</td>`).join('')}
                                            <td>${calculateGrowthRate('operating', 'cashFlow')}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Red Flag Analysis -->
                            <div class="subsection" style="margin-top: 20px; border-left: 4px solid #d32f2f;">
                                <h3><i class="fas fa-flag"></i> Financial Red Flags</h3>
                                <div style="background-color: #ffebee; padding: 15px; border-radius: 8px;">
                                    ${analyzeFinancialRedFlags()}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visualizations -->
                    <div class="year-content" id="financial-visualizations">
                        <div class="subsection">
                            <h3><i class="fas fa-chart-bar"></i> Financial Data Visualizations</h3>
                            
                            <div class="visualization-grid">
                                <!-- Profitability Trend Chart -->
                                <div class="visualization-card">
                                    <h4><i class="fas fa-chart-line"></i> Profitability Trend</h4>
                                    <div class="chart-wrapper">
                                        <canvas id="profitabilityChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Balance Sheet Composition -->
                                <div class="visualization-card">
                                    <h4><i class="fas fa-chart-pie"></i> Balance Sheet Composition</h4>
                                    <div class="chart-wrapper">
                                        <canvas id="balanceSheetChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Cash Flow Analysis -->
                                <div class="visualization-card">
                                    <h4><i class="fas fa-chart-bar"></i> Cash Flow Analysis</h4>
                                    <div class="chart-wrapper">
                                        <canvas id="cashFlowChart"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Ratio Trend Analysis -->
                                <div class="visualization-card">
                                    <h4><i class="fas fa-chart-line"></i> Ratio Trend Analysis</h4>
                                    <div class="chart-wrapper">
                                        <canvas id="ratioTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-row">
                                <!-- Year-over-Year Comparison -->
                                <div class="chart-item">
                                    <div class="chart-container">
                                        <div class="chart-title"><i class="fas fa-chart-bar"></i> Year-over-Year Revenue vs Profit</div>
                                        <div class="chart-wrapper">
                                            <canvas id="revenueProfitComparisonChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Financial Health Radar -->
                                <div class="chart-item">
                                    <div class="chart-container">
                                        <div class="chart-title"><i class="fas fa-bullseye"></i> Financial Health Radar</div>
                                        <div class="chart-wrapper">
                                            <canvas id="financialHealthRadar"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            financialTab.insertAdjacentHTML('beforeend', financialContent);
            
            // Now create financial visualizations
            createFinancialVisualizations();
        }

        // Create financial visualizations
        function createFinancialVisualizations() {
            const years = currentCompany.years;
            
            // 1. Profitability Trend Chart
            if (currentCompany.financialAnalysis?.profitLoss) {
                const revenueData = years.map(year => {
                    const value = currentCompany.financialAnalysis.profitLoss[year]?.revenue;
                    return value ? parseFloat(value.replace(/[^0-9.-]+/g, '')) : 0;
                });
                
                const netProfitData = years.map(year => {
                    const value = currentCompany.financialAnalysis.profitLoss[year]?.netProfit;
                    if (!value) return 0;
                    const num = parseFloat(value.replace(/[(),]/g, ''));
                    return value.startsWith('(') ? -num : num;
                });
                
                createLineChart('profitabilityChart', {
                    labels: years,
                    datasets: [
                        {
                            label: 'Revenue',
                            data: revenueData,
                            borderColor: '#1a3a8f',
                            backgroundColor: 'rgba(26, 58, 143, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Net Profit/(Loss)',
                            data: netProfitData,
                            borderColor: netProfitData[netProfitData.length-1] >= 0 ? '#388e3c' : '#d32f2f',
                            backgroundColor: netProfitData[netProfitData.length-1] >= 0 ? 'rgba(56, 142, 60, 0.1)' : 'rgba(211, 47, 47, 0.1)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                });
            }
            
            // 2. Balance Sheet Composition Chart (for latest year)
            if (currentCompany.financialAnalysis?.balanceSheet) {
                const latestYear = years[years.length - 1];
                const balanceData = currentCompany.financialAnalysis.balanceSheet[latestYear];
                
                if (balanceData) {
                    const assetLabels = ['PPE', 'Investments', 'Inventory', 'Other Assets'];
                    const assetData = [
                        parseFloat(balanceData.ppe?.replace(/[^0-9.-]+/g, '') || 0),
                        parseFloat(balanceData.investments?.replace(/[^0-9.-]+/g, '') || 0),
                        parseFloat(balanceData.inventory?.replace(/[^0-9.-]+/g, '') || 0),
                        parseFloat(balanceData.otherAssets?.replace(/[^0-9.-]+/g, '') || 0)
                    ];
                    
                    createDoughnutChart('balanceSheetChart', {
                        labels: assetLabels,
                        datasets: [{
                            data: assetData,
                            backgroundColor: ['#1a3a8f', '#2a5bd7', '#4a7cff', '#8aadff'],
                            borderColor: ['#0d1f5c', '#1a3a8f', '#2a5bd7', '#4a7cff'],
                            borderWidth: 1
                        }]
                    });
                }
            }
            
            // 3. Cash Flow Analysis Chart
            if (currentCompany.financialAnalysis?.cashFlow) {
                const operatingData = years.map(year => 
                    parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.operating || 0)
                );
                const investingData = years.map(year => 
                    parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.investing || 0)
                );
                const financingData = years.map(year => 
                    parseFloat(currentCompany.financialAnalysis.cashFlow[year]?.financing || 0)
                );
                
                createBarChart('cashFlowChart', {
                    labels: years,
                    datasets: [
                        {
                            label: 'Operating',
                            data: operatingData,
                            backgroundColor: operatingData.map(val => val >= 0 ? 'rgba(56, 142, 60, 0.7)' : 'rgba(211, 47, 47, 0.7)'),
                            borderColor: operatingData.map(val => val >= 0 ? '#388e3c' : '#d32f2f'),
                            borderWidth: 1
                        },
                        {
                            label: 'Investing',
                            data: investingData,
                            backgroundColor: investingData.map(val => val >= 0 ? 'rgba(26, 58, 143, 0.7)' : 'rgba(245, 124, 0, 0.7)'),
                            borderColor: investingData.map(val => val >= 0 ? '#1a3a8f' : '#f57c00'),
                            borderWidth: 1
                        },
                        {
                            label: 'Financing',
                            data: financingData,
                            backgroundColor: financingData.map(val => val >= 0 ? 'rgba(123, 31, 162, 0.7)' : 'rgba(156, 39, 176, 0.7)'),
                            borderColor: financingData.map(val => val >= 0 ? '#7b1fa2' : '#9c27b0'),
                            borderWidth: 1
                        }
                    ]
                });
            }
            
            // 4. Ratio Trend Chart
            if (currentCompany.financialAnalysis?.ratios) {
                const ratioKeys = ['currentRatio', 'debtToEquity', 'returnOnAssets', 'grossMargin'];
                const ratioDatasets = ratioKeys.map((key, index) => {
                    const data = years.map(year => {
                        const value = currentCompany.financialAnalysis.ratios[year]?.[key];
                        return value ? parseFloat(value) : 0;
                    });
                    
                    const colors = ['#1a3a8f', '#d32f2f', '#388e3c', '#f57c00'];
                    const color = colors[index % colors.length];
                    
                    return {
                        label: formatRatioName(key),
                        data: data,
                        borderColor: color,
                        backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                        tension: 0.1,
                        fill: false
                    };
                });
                
                createLineChart('ratioTrendChart', {
                    labels: years,
                    datasets: ratioDatasets
                });
            }
            
            // 5. Revenue vs Profit Comparison Chart
            if (currentCompany.financialAnalysis?.profitLoss) {
                const revenueData = years.map(year => {
                    const value = currentCompany.financialAnalysis.profitLoss[year]?.revenue;
                    return value ? parseFloat(value.replace(/[^0-9.-]+/g, '')) / 1000000 : 0; // Convert to millions
                });
                
                const profitData = years.map(year => {
                    const value = currentCompany.financialAnalysis.profitLoss[year]?.netProfit;
                    if (!value) return 0;
                    const num = parseFloat(value.replace(/[(),]/g, ''));
                    return (value.startsWith('(') ? -num : num) / 1000000; // Convert to millions
                });
                
                createBarChart('revenueProfitComparisonChart', {
                    labels: years,
                    datasets: [
                        {
                            label: 'Revenue (Millions)',
                            data: revenueData,
                            backgroundColor: 'rgba(26, 58, 143, 0.7)',
                            borderColor: '#1a3a8f',
                            borderWidth: 1
                        },
                        {
                            label: 'Net Profit/(Loss) (Millions)',
                            data: profitData,
                            backgroundColor: profitData.map(val => val >= 0 ? 'rgba(56, 142, 60, 0.7)' : 'rgba(211, 47, 47, 0.7)'),
                            borderColor: profitData.map(val => val >= 0 ? '#388e3c' : '#d32f2f'),
                            borderWidth: 1
                        }
                    ]
                });
            }
            
            // 6. Financial Health Radar Chart
            if (currentCompany.financialAnalysis?.ratios) {
                const latestYear = years[years.length - 1];
                const ratios = currentCompany.financialAnalysis.ratios[latestYear];
                
                if (ratios) {
                    const radarLabels = ['Liquidity', 'Solvency', 'Profitability', 'Efficiency', 'Cash Flow'];
                    const radarData = [
                        parseFloat(ratios.currentRatio || 0) / 3 * 100, // Normalize to 0-100 scale
                        Math.max(0, 100 - (parseFloat(ratios.debtToEquity || 0) * 100)), // Invert so lower debt is better
                        Math.max(0, parseFloat(ratios.returnOnAssets || 0) * 10), // Scale up
                        parseFloat(ratios.grossMargin || 0) * 2, // Scale up
                        parseFloat(ratios.cashFlowToIncome || 0) * 50 // Scale up
                    ];
                    
                    createRadarChart('financialHealthRadar', {
                        labels: radarLabels,
                        datasets: [{
                            label: `Financial Health (${latestYear})`,
                            data: radarData,
                            backgroundColor: 'rgba(26, 58, 143, 0.2)',
                            borderColor: '#1a3a8f',
                            pointBackgroundColor: '#1a3a8f',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#1a3a8f'
                        }]
                    });
                }
            }
        }

        // Chart creation helper functions
        function createLineChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        function createPieChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function createDoughnutChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        function createRadarChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // Load compliance data with visualizations
        function loadComplianceData() {
            const complianceTab = document.getElementById('tab-compliance');
            
            if (!currentCompany.ifrsCompliance) {
                complianceTab.innerHTML += '<div class="section"><h2><i class="fas fa-exclamation-triangle"></i> No IFRS Compliance Data</h2><p>This company does not have IFRS compliance data available.</p></div>';
                return;
            }

            let complianceContent = `
                <div class="section">
                    <h2><i class="fas fa-chart-line"></i> IFRS/IAS Compliance</h2>
                    
                    ${currentCompany.ifrsCompliance.standards ? `
                    <div class="subsection">
                        <h3><i class="fas fa-clipboard-check"></i> Compliance Status by Standard</h3>
                        
                        <div class="standard-compliance-grid">
                            ${Object.entries(currentCompany.ifrsCompliance.standards).map(([standard, data]) => `
                                <div class="standard-card ${data[currentCompany.years[currentCompany.years.length - 1]] || 'non-compliant'}">
                                    <h4>${standard}: ${data.name || 'Unknown Standard'}</h4>
                                    <p><strong>Status (${currentCompany.years[currentCompany.years.length - 1]}):</strong> 
                                        <span class="compliance-badge ${data[currentCompany.years[currentCompany.years.length - 1]] || 'non-compliant'}">
                                            ${data[currentCompany.years[currentCompany.years.length - 1]] === 'partial' ? 'Partial' : 
                                              data[currentCompany.years[currentCompany.years.length - 1]] === 'non-compliant' ? 'Non-compliant' : 
                                              data[currentCompany.years[currentCompany.years.length - 1]] === 'compliant' ? 'Compliant' : 'Unknown'}
                                        </span>
                                    </p>
                                    <p>${data.issues || 'No issues documented'}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="subsection">
                        <h3><i class="fas fa-chart-bar"></i> Compliance Trend Analysis</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Standard</th>
                                    ${currentCompany.years.map(year => `<th>${year}</th>`).join('')}
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(currentCompany.ifrsCompliance.standards).map(([standard, data]) => `
                                    <tr>
                                        <td>${standard}</td>
                                        ${currentCompany.years.map(year => `
                                            <td><span class="compliance-badge ${data[year] || 'non-compliant'}">${data[year] === 'partial' ? 'P' : data[year] === 'non-compliant' ? 'N' : data[year] === 'compliant' ? 'C' : 'N/A'}</span></td>
                                        `).join('')}
                                        <td>${getComplianceTrend(data)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : '<p>No compliance standards data available.</p>'}
                </div>
            `;

            complianceTab.insertAdjacentHTML('beforeend', complianceContent);
            
            // Add compliance visualizations
            addComplianceVisualizations();
        }

        // Add compliance visualizations
        function addComplianceVisualizations() {
            if (!currentCompany.ifrsCompliance?.standards) return;
            
            const complianceTab = document.getElementById('tab-compliance');
            
            const vizSection = document.createElement('div');
            vizSection.className = 'section';
            vizSection.innerHTML = `
                <h2><i class="fas fa-chart-pie"></i> Compliance Visualizations</h2>
                <div class="subsection">
                    <h3><i class="fas fa-chart-bar"></i> IFRS Compliance Analysis</h3>
                    
                    <div class="visualization-grid">
                        <!-- Compliance Status Overview -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-pie"></i> Overall Compliance Status</h4>
                            <div class="chart-wrapper">
                                <canvas id="complianceOverviewChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Compliance Trend Chart -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-line"></i> Compliance Trend Over Years</h4>
                            <div class="chart-wrapper">
                                <canvas id="complianceTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Standard-wise Compliance -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-bar"></i> Standard-wise Compliance</h4>
                            <div class="chart-wrapper">
                                <canvas id="standardComplianceChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Year-wise Comparison -->
                        <div class="visualization-card">
                            <h4><i class="fas fa-chart-bar"></i> Year-wise Compliance Comparison</h4>
                            <div class="chart-wrapper">
                                <canvas id="yearComplianceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            complianceTab.appendChild(vizSection);
            
            // Now create compliance charts
            createComplianceCharts();
        }

        // Create compliance charts
        function createComplianceCharts() {
            const years = currentCompany.years;
            const standards = currentCompany.ifrsCompliance.standards;
            
            // 1. Compliance Overview Chart (Pie chart for latest year)
            const latestYear = years[years.length - 1];
            let compliantCount = 0, partialCount = 0, nonCompliantCount = 0;
            
            Object.values(standards).forEach(standard => {
                const status = standard[latestYear];
                if (status === 'compliant') compliantCount++;
                else if (status === 'partial') partialCount++;
                else nonCompliantCount++;
            });
            
            createPieChart('complianceOverviewChart', {
                labels: ['Compliant', 'Partial', 'Non-compliant'],
                datasets: [{
                    data: [compliantCount, partialCount, nonCompliantCount],
                    backgroundColor: ['#2e7d32', '#f57c00', '#d32f2f'],
                    borderColor: ['#1b5e20', '#e65100', '#b71c1c'],
                    borderWidth: 1
                }]
            });
            
            // 2. Compliance Trend Chart (Line chart showing trend over years)
            const complianceTrendData = years.map(year => {
                let compliantInYear = 0;
                Object.values(standards).forEach(standard => {
                    if (standard[year] === 'compliant') compliantInYear++;
                });
                return (compliantInYear / Object.keys(standards).length) * 100;
            });
            
            createLineChart('complianceTrendChart', {
                labels: years,
                datasets: [{
                    label: '% of Compliant Standards',
                    data: complianceTrendData,
                    borderColor: '#1a3a8f',
                    backgroundColor: 'rgba(26, 58, 143, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            });
            
            // 3. Standard-wise Compliance (Bar chart for top standards)
            const standardNames = Object.keys(standards).slice(0, 10); // Show top 10 standards
            const standardComplianceData = standardNames.map(standard => {
                const status = standards[standard][latestYear];
                if (status === 'compliant') return 100;
                if (status === 'partial') return 50;
                return 0;
            });
            
            createBarChart('standardComplianceChart', {
                labels: standardNames,
                datasets: [{
                    label: `Compliance Score (${latestYear})`,
                    data: standardComplianceData,
                    backgroundColor: standardComplianceData.map(score => {
                        if (score === 100) return '#2e7d32';
                        if (score === 50) return '#f57c00';
                        return '#d32f2f';
                    }),
                    borderColor: standardComplianceData.map(score => {
                        if (score === 100) return '#1b5e20';
                        if (score === 50) return '#e65100';
                        return '#b71c1c';
                    }),
                    borderWidth: 1
                }]
            });
            
            // 4. Year-wise Compliance Comparison (Stacked bar chart)
            const yearComplianceData = years.map(year => {
                let compliant = 0, partial = 0, nonCompliant = 0;
                Object.values(standards).forEach(standard => {
                    const status = standard[year];
                    if (status === 'compliant') compliant++;
                    else if (status === 'partial') partial++;
                    else nonCompliant++;
                });
                return { compliant, partial, nonCompliant };
            });
            
            createBarChart('yearComplianceChart', {
                labels: years,
                datasets: [
                    {
                        label: 'Compliant',
                        data: yearComplianceData.map(d => d.compliant),
                        backgroundColor: '#2e7d32',
                        borderColor: '#1b5e20',
                        borderWidth: 1
                    },
                    {
                        label: 'Partial',
                        data: yearComplianceData.map(d => d.partial),
                        backgroundColor: '#f57c00',
                        borderColor: '#e65100',
                        borderWidth: 1
                    },
                    {
                        label: 'Non-compliant',
                        data: yearComplianceData.map(d => d.nonCompliant),
                        backgroundColor: '#d32f2f',
                        borderColor: '#b71c1c',
                        borderWidth: 1
                    }
                ]
            });
        }

        // The rest of your existing functions remain exactly the same...
        // I've only shown the functions that were modified or added for visualizations
        // All other functions (loadAuditAnalysisData, loadRiskIndicatorsData, etc.) remain unchanged

        // Add the rest of your existing JavaScript code here...
        // This includes all the helper functions, PDF generation, etc.
        // I've only shown the modified and new functions above

    </script>
</body>
</html>