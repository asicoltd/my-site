<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transposed Performance Tracker</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body {
    margin:0;
    font-family: system-ui,sans-serif;
    background:#0f172a;
    color:#e5e7eb;
    padding:12px;
}
h1 { text-align:center; margin-bottom:12px; color:#6ee7b7; font-size:1.8rem; }

/* Controls */
.controls {
    display:flex; flex-wrap:wrap; justify-content:center; gap:8px; margin-bottom:12px;
}
.controls input, .controls select, .controls button {
    padding:6px 10px; border-radius:6px; border:none; font-size:14px;
}
.controls input, .controls select { background:#1e293b; color:#e5e7eb; }
.controls button { background:#2563eb; color:white; cursor:pointer; }

/* Grid container */
#weekView { overflow:auto; margin-bottom:12px; }
.week-grid {
    display:grid;
    gap:4px;
}

/* Transposed grid: first column = hour, rest = days */
.hour-label {
    background:#020617; text-align:center; font-size:12px; padding:6px 2px; border-radius:4px;
}
.day-label { writing-mode: vertical-rl; transform: rotate(180deg); font-size:12px; text-align:center; padding:2px; color:#93c5fd; }

.hour-cell { width:32px; height:32px; border:1px solid #334155; cursor:pointer; }
.black { background:#111827; }
.sleep { background:#1e40af; }
.wasted { background:#4b5563; }
.full { background:#059669; }
.semi { background:#f59e0b; }
.clg { background:#7c3aed; }

/* Legend */
.legend { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:12px; }
.legend-item { display:flex; align-items:center; gap:6px; font-size:12px; }
.color-box { width:18px; height:18px; border-radius:3px; }

/* Capture hidden */
#capture { position:fixed; left:-9999px; top:0; padding:16px; background:#0f172a; border-radius:12px; }
</style>
</head>
<body>

<h1>Transposed Tracker</h1>

<div class="controls">
    <input type="date" id="startDate">
    <select id="modeSelect">
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
    </select>
    <button onclick="generate()">Apply</button>
    <button onclick="downloadGrid()">Download</button>
</div>

<div id="weekView">
    <div class="week-grid" id="weekGrid"></div>
</div>

<div class="legend">
    <div class="legend-item"><div class="color-box sleep"></div>Sleep</div>
    <div class="legend-item"><div class="color-box wasted"></div>Wasted</div>
    <div class="legend-item"><div class="color-box full"></div>Full Focused</div>
    <div class="legend-item"><div class="color-box semi"></div>Semi Focused</div>
    <div class="legend-item"><div class="color-box clg"></div>CLG</div>
    <div class="legend-item"><div class="color-box black"></div>Idle</div>
</div>

<div id="capture">
    <div class="week-grid" id="captureGrid"></div>
</div>

<script>
const states = ["black","sleep","wasted","full","semi","clg"];
const weekGrid = document.getElementById("weekGrid");
const captureGrid = document.getElementById("captureGrid");
const startInput = document.getElementById("startDate");
const modeSelect = document.getElementById("modeSelect");

startInput.valueAsDate = new Date();

function formatDate(date){
    const d=String(date.getDate()).padStart(2,'0');
    const m=String(date.getMonth()+1).padStart(2,'0');
    const y=String(date.getFullYear()).slice(-2);
    return `${d}/${m}/${y}`;
}

function loadHistory(key){
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : {};
}
function saveHistory(key,data){
    localStorage.setItem(key,JSON.stringify(data));
}

function generate(){
    weekGrid.innerHTML = ""; captureGrid.innerHTML="";
    const mode = modeSelect.value;
    const start = new Date(startInput.value);
    const days = mode==="weekly"?7:28;
    const historyKey = mode==="weekly"?"weekHistory":"monthHistory";
    const history = loadHistory(historyKey);

    // grid-template: rows = hours, columns = days+1
    weekGrid.style.gridTemplateColumns=`repeat(${days+1}, auto)`;
    captureGrid.style.gridTemplateColumns=`repeat(${days+1}, auto)`;

    // header row (empty top-left + day labels)
    const header = document.createElement("div"); header.className="hour-label"; header.textContent="Hour"; weekGrid.appendChild(header);
    const headerC = header.cloneNode(true); captureGrid.appendChild(headerC);
    for(let d=0; d<days; d++){
        const day = new Date(start); day.setDate(start.getDate()+d);
        const dayLabel = document.createElement("div"); dayLabel.className="day-label"; dayLabel.textContent=formatDate(day);
        const dayLabelC = dayLabel.cloneNode(true);
        weekGrid.appendChild(dayLabel); captureGrid.appendChild(dayLabelC);
    }

    // rows for each hour
    for(let h=0; h<24; h++){
        const hourLabel = document.createElement("div"); hourLabel.className="hour-label"; hourLabel.textContent=h;
        const hourLabelC = hourLabel.cloneNode(true);
        weekGrid.appendChild(hourLabel); captureGrid.appendChild(hourLabelC);

        for(let d=0; d<days; d++){
            const day = new Date(start); day.setDate(start.getDate()+d);
            const fdate = formatDate(day);

            const cell = document.createElement("div"); cell.className="hour-cell black"; cell.dataset.state=0;
            const cellC = cell.cloneNode(true);

            if(history[fdate] && history[fdate][h]!=undefined){
                cell.dataset.state=history[fdate][h]; cell.className="hour-cell "+states[history[fdate][h]];
            }

            cell.onclick = ()=>{
                let s=Number(cell.dataset.state); cell.classList.remove(states[s]);
                s=(s+1)%states.length; cell.dataset.state=s; cell.classList.add(states[s]);
                history[fdate]=history[fdate]||[]; history[fdate][h]=s; saveHistory(historyKey,history);
            };

            weekGrid.appendChild(cell); captureGrid.appendChild(cellC);
        }
    }
}

/* Download */
function downloadGrid(){
    html2canvas(document.getElementById("capture"),{scale:2,backgroundColor:"#0f172a"}).then(canvas=>{
        const link=document.createElement("a"); link.download="transposed-grid.png";
        link.href=canvas.toDataURL(); link.click();
    });
}

/* Reminder Notifications */
if("Notification" in window){
    Notification.requestPermission();
    setInterval(()=>{
        if(Notification.permission==="granted"){
            new Notification("Update Performance Tracker","Click hour blocks to update your status!");
        }
    },3600*1000);
}

generate();
</script>
</body>
</html>
